<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtSpace - ‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏á‡∏≤‡∏ô‡∏®‡∏¥‡∏•‡∏õ‡πå</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&family=Prompt:wght@400;600;700&display=swap');

        :root {
            --bg-color: #faf9f6;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --accent: #6c5ce7;
            --accent-hover: #5849be;
            --danger: #ff4757;
            --success: #00b894;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow-md: 0 10px 30px rgba(0,0,0,0.08);
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow: hidden; /* Lock scroll during intro */
        }

        .hidden { display: none !important; }

        /* ================= INTRO ANIMATION (FIXED SMOOTH) ================= */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            /* Transition for Curtain Effect */
            transition: transform 1.2s cubic-bezier(0.86, 0, 0.07, 1); 
            will-change: transform;
        }
        .curtain-open { transform: translateY(-100%); } /* Slide Up */

        #animCanvas { position: absolute; top: 0; left: 0; }

        .skip-hint {
            position: absolute; bottom: 50px; color: #b2bec3;
            font-family: 'Prompt', sans-serif; font-size: 24px; font-weight: 600;
            letter-spacing: 1px; animation: pulse 2s infinite; pointer-events: none;
            z-index: 10000; transition: opacity 0.5s;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }

        /* ================= MAIN SITE ================= */
        #main-site {
            position: relative; z-index: 1; height: 100vh; overflow-y: auto;
            opacity: 0; transition: opacity 0.5s ease-in; /* Fade in smoothly */
        }
        .site-visible { opacity: 1 !important; }

        .reveal-element { opacity: 0; transform: translateY(30px); transition: all 0.8s ease; }
        .reveal-active { opacity: 1; transform: translateY(0); }

        /* ================= UI COMPONENTS ================= */
        nav {
            position: sticky; top: 0; z-index: 100;
            background: var(--glass); backdrop-filter: blur(12px);
            padding: 15px 40px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .logo { font-family: 'Prompt', sans-serif; font-size: 24px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; cursor: pointer;}
        .logo span { color: var(--accent); }
        
        .search-bar input {
            width: 300px; padding: 10px 20px 10px 40px; border-radius: 50px; border: 1px solid #dfe6e9;
            background: #fff; font-family: 'Sarabun'; outline: none; transition: 0.3s;
        }
        
        .btn-nav {
            background: transparent; border: 1px solid transparent; padding: 8px 16px; border-radius: 12px;
            font-weight: 600; color: var(--text-muted); cursor: pointer; transition: 0.2s; font-family: 'Prompt';
        }
        .btn-nav:hover { background: rgba(0,0,0,0.03); color: var(--text-main); }
        .btn-primary { background: var(--accent); color: white !important; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); }

        /* Sections */
        .top-artists-section { padding: 40px 20px; text-align: center; background: linear-gradient(180deg, #fff 0%, var(--bg-color) 100%); }
        .top-grid { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-top:30px; }
        
        .artist-rank-card {
            background: white; padding: 20px; border-radius: 20px; width: 200px;
            box-shadow: var(--shadow-md); position: relative; transition: 0.3s; display: flex; flex-direction: column; align-items: center;
        }
        .artist-rank-card:hover { transform: translateY(-5px); }
        .artist-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        
        /* Gallery */
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px 100px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; }
        
        .art-card {
            background: white; border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-md);
            transition: all 0.3s ease; position: relative;
        }
        .art-card:hover { transform: translateY(-5px); }
        .card-img { width: 100%; height: 250px; object-fit: cover; }
        
        /* Badges */
        .sold-badge {
            position: absolute; top: 10px; right: 10px; background: var(--danger); color: white;
            padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 12px; z-index: 10;
        }
        
        /* Admin & Reset Buttons */
        .reset-btn-float {
            position: fixed; bottom: 20px; right: 20px; background: var(--danger);
            color: white; border: none; padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); cursor: pointer;
            z-index: 5000; font-family: 'Prompt'; font-weight: bold; transition: 0.3s;
        }
        .reset-btn-float:hover { transform: scale(1.05); }

        .admin-user-row {
            display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;
        }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 6000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal.open { display: flex; }
        .modal-box { background: white; width: 450px; padding: 30px; border-radius: 20px; text-align: center; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 20px; color: #aaa; }
        
        .form-control { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .buy-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }

    </style>
</head>
<body>

    <div id="intro-overlay">
        <canvas id="animCanvas"></canvas>
        <div class="skip-hint">‡∏Å‡∏î Spacebar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°</div>
    </div>

    <button id="admin-reset-btn" class="reset-btn-float hidden" onclick="systemReset()">
        <i class="fas fa-sync-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö (Factory Reset)
    </button>

    <div id="auth-modal" class="modal">
        <div class="modal-box">
            <div class="close-modal" onclick="closeModal('auth-modal')"><i class="fas fa-times"></i></div>
            <h2 id="auth-title" style="margin-bottom: 20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <input type="email" id="loginEmail" class="form-control" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (admin@artspace.com)" required>
                <input type="password" id="loginPass" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (admin888)" required>
                <button type="submit" class="buy-btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <p style="margin-top:10px; font-size:13px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="#" onclick="toggleAuth('register')">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a></p>
            </form>

            <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                <input type="text" id="regName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á (Display Name)" required>
                <input type="email" id="regEmail" class="form-control" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                <input type="password" id="regPass" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                <button type="submit" class="buy-btn" style="background: var(--success);">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                <p style="margin-top:10px; font-size:13px;">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <a href="#" onclick="toggleAuth('login')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></p>
            </form>
        </div>
    </div>

    <div id="main-site">
        <nav>
            <div class="logo" onclick="resetView()"><i class="fas fa-palette"></i> Art<span>Space</span></div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û..." onkeyup="searchGallery()">
            </div>
            
            <div id="guest-nav">
                <button class="btn-nav" onclick="openAuthModal()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button class="btn-nav btn-primary" onclick="openAuthModal('register')">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>

            <div id="user-nav" class="hidden" style="display: flex; align-items: center; gap: 15px;">
                <button class="btn-nav" id="my-studio-btn" onclick="openMyStudio()">
                    <i class="fas fa-store"></i> ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
                <div style="text-align:right;">
                    <div id="display-name" style="font-weight:bold;">User</div>
                    <div id="display-role" style="font-size:12px; color:#aaa;">Member</div>
                </div>
                <button class="btn-nav" onclick="logout()" style="color:var(--danger);"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </nav>

        <section class="top-artists-section">
            <h2>üèÜ 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö <span>‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</span></h2>
            <div class="top-grid" id="top-artists-grid"></div>
        </section>

        <div class="container">
            <div id="admin-panel" class="hidden" style="background:white; padding:20px; border-radius:15px; margin-bottom:30px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                <h3>üõ°Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Admin Only)</h3>
                <div id="user-list-container" style="margin-top:15px;"></div>
            </div>

            <div id="studio-panel" class="hidden" style="background:white; padding:20px; border-radius:15px; margin-bottom:30px;">
                <div style="display:flex; gap:15px; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <div style="cursor:pointer; font-weight:bold;" onclick="renderMyStudio('uploaded')">üì§ ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏Ç‡∏≤‡∏¢</div>
                    <div style="cursor:pointer; font-weight:bold; color:var(--accent);" onclick="renderMyStudio('bought')">üõçÔ∏è ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß)</div>
                </div>
                
                <form id="upload-form" onsubmit="handleUpload(event)" style="display: flex; gap: 10px; align-items: center;">
                    <b>‡∏•‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:</b>
                    <input type="text" id="upTitle" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required style="margin:0; width:150px;">
                    <input type="number" id="upPrice" class="form-control" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required style="margin:0; width:100px;">
                    <select id="upCategory" class="form-control" style="margin:0; width:120px;">
                        <option value="digital">Digital</option>
                        <option value="painting">Painting</option>
                        <option value="photo">Photo</option>
                    </select>
                    <input type="file" id="upImage" class="form-control" accept="image/*" required style="margin:0; width:200px;">
                    <button type="submit" class="btn-nav btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                </form>
            </div>

            <div class="filters">
                <button class="filter-btn active" onclick="filterGallery('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" onclick="filterGallery('digital', this)">‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</button>
                <button class="filter-btn" onclick="filterGallery('painting', this)">‡∏†‡∏≤‡∏û‡∏ß‡∏≤‡∏î</button>
                <button class="filter-btn" onclick="filterGallery('photo', this)">‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢</button>
                <button class="filter-btn" onclick="filterGallery('sold', this)" style="color:var(--danger); border-color:var(--danger);">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>

            <div class="gallery-grid" id="gallery"></div>
        </div>
    </div>

    <script>
        // ================= 1. INTRO ANIMATION (Fixed & Smooth) =================
        const canvas = document.getElementById('animCanvas');
        const ctx = canvas.getContext('2d');
        const introOverlay = document.getElementById('intro-overlay');
        const mainSite = document.getElementById('main-site');
        const skipHint = document.querySelector('.skip-hint');
        let animId;

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        const cx = window.innerWidth / 2, cy = window.innerHeight / 2;
        const balls = [];
        const particles = [];
        let phase = 'rolling'; // rolling -> expanding -> finished
        let frameCount = 0;
        const timeToHit = 120; // Frames until explosion

        // Init Rolling Balls
        for(let i=0; i<8; i++) {
            const angle = (i * (Math.PI * 2) / 8) + Math.random();
            const dist = Math.max(window.innerWidth, window.innerHeight) * 0.8;
            balls.push({
                x: cx + Math.cos(angle) * dist,
                y: cy + Math.sin(angle) * dist,
                vx: (cx - (cx + Math.cos(angle) * dist)) / timeToHit,
                vy: (cy - (cy + Math.sin(angle) * dist)) / timeToHit,
                color: ['#ff7675', '#74b9ff', '#55efc4', '#ffeaa7', '#a29bfe', '#fd79a8', '#fab1a0', '#81ecec'][i]
            });
        }

        function createExplosion() {
            for(let i=0; i<250; i++) {
                particles.push({
                    x: cx, y: cy,
                    vx: (Math.random() - 0.5) * 60,
                    vy: (Math.random() - 0.5) * 60,
                    radius: Math.random() * 30 + 5,
                    color: balls[Math.floor(Math.random()*8)].color,
                    growth: Math.random() * 2 + 1
                });
            }
        }

        function animateIntro() {
            if(phase === 'finished') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // IMPORTANT: Clear screen

            if(phase === 'rolling') {
                frameCount++;
                balls.forEach(b => {
                    b.x += b.vx; b.y += b.vy;
                    ctx.beginPath(); ctx.arc(b.x, b.y, 80, 0, Math.PI*2); ctx.fillStyle = b.color; ctx.fill();
                });
                if(frameCount >= timeToHit) { 
                    phase = 'expanding'; 
                    skipHint.style.opacity = '0'; 
                    createExplosion(); 
                }
            }
            if(phase === 'expanding') {
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vx *= 0.95; p.vy *= 0.95; // Friction
                    p.radius += p.growth;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2); ctx.fillStyle = p.color; ctx.fill();
                });
                // Check if filled screen (approx)
                if(particles[0].radius > Math.max(window.innerWidth, window.innerHeight)) { 
                    finishIntro(); 
                    return; 
                }
            }
            animId = requestAnimationFrame(animateIntro);
        }
        
        // Start
        animateIntro();
        setTimeout(() => { if(!isEntered) finishIntro(); }, 4000); // Safety timeout

        let isEntered = false;
        function finishIntro() {
            if(isEntered) return;
            isEntered = true;
            cancelAnimationFrame(animId);
            
            // Curtain Effect
            introOverlay.classList.add('curtain-open');
            mainSite.classList.add('site-visible');
            document.body.style.overflow = 'auto'; // Unlock scroll
            
            setTimeout(() => { introOverlay.style.display = 'none'; }, 1200); // Remove after anim
        }
        document.addEventListener('keydown', (e) => { if(e.code === 'Space') finishIntro(); });


        // ================= 2. DATA SYSTEM (LocalStorage) =================
        const defaultUsers = [
            { email: 'admin@artspace.com', pass: 'admin888', name: 'Admin', role: 'admin' },
            { email: 'user@test.com', pass: '123456', name: 'Test User', role: 'member' }
        ];
        
        const defaultArt = [
            { id: 1, title: "Forest Guardian", artist: "Admin", owner: "Admin", price: 15900, category: "digital", img: "img/1.jpg", isSold: false, sales: 50 },
            { id: 2, title: "Neon City", artist: "Admin", owner: "Admin", price: 9900, category: "digital", img: "img/2.jpg", isSold: false, sales: 20 },
            { id: 3, title: "Winter Spirit", artist: "Admin", owner: "Admin", price: 12000, category: "painting", img: "img/3.jpg", isSold: false, sales: 10 },
            { id: 4, title: "Ronin Path", artist: "Admin", owner: "Admin", price: 18000, category: "digital", img: "img/4.jpg", isSold: false, sales: 30 },
            { id: 5, title: "Sacred Gate", artist: "Admin", owner: "Admin", price: 8900, category: "digital", img: "img/5.jpg", isSold: false, sales: 40 },
            { id: 6, title: "Cursed Eye", artist: "Admin", owner: "Admin", price: 14500, category: "digital", img: "img/6.jpg", isSold: false, sales: 15 },
            { id: 7, title: "Red Sun", artist: "Admin", owner: "Admin", price: 11000, category: "digital", img: "img/7.jpg", isSold: false, sales: 25 },
            { id: 8, title: "Dragon Mark", artist: "Admin", owner: "Admin", price: 9500, category: "digital", img: "img/8.jpg", isSold: false, sales: 60 }
        ];

        let users = [];
        let artworks = [];
        let currentUser = null;

        function initSystem() {
            if(localStorage.getItem('as_users')) {
                users = JSON.parse(localStorage.getItem('as_users'));
                artworks = JSON.parse(localStorage.getItem('as_artworks'));
            } else {
                // First time load
                users = [...defaultUsers];
                artworks = [...defaultArt];
                saveSystem();
            }
            
            // Check Session
            const session = sessionStorage.getItem('as_session');
            if(session) {
                currentUser = JSON.parse(session);
                updateUI();
            }
            
            renderGallery(artworks);
            renderTopArtists();
        }

        function saveSystem() {
            localStorage.setItem('as_users', JSON.stringify(users));
            localStorage.setItem('as_artworks', JSON.stringify(artworks));
        }

        function systemReset() {
            if(confirm('üî¥ ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (Factory Reset)')) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload();
            }
        }

        // ================= 3. AUTH & USER MANAGEMENT =================
        function toggleAuth(mode) {
            if(mode === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
                document.getElementById('auth-title').innerText = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà';
            } else {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('auth-title').innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;

            if(users.find(u => u.email === email)) {
                alert('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return;
            }

            const newUser = { email, pass, name, role: 'member' };
            users.push(newUser);
            saveSystem();
            
            // Auto Login
            currentUser = newUser;
            sessionStorage.setItem('as_session', JSON.stringify(currentUser));
            updateUI();
            closeModal('auth-modal');
            alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            
            const foundUser = users.find(u => u.email === email && u.pass === pass);
            if(foundUser) {
                currentUser = foundUser;
                sessionStorage.setItem('as_session', JSON.stringify(currentUser));
                updateUI();
                closeModal('auth-modal');
                alert(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${currentUser.name}`);
            } else {
                alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
        }

        function logout() {
            if(confirm('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
                currentUser = null;
                sessionStorage.removeItem('as_session');
                location.reload();
            }
        }

        function updateUI() {
            if(currentUser) {
                document.getElementById('guest-nav').classList.add('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                document.getElementById('display-name').innerText = currentUser.name;
                document.getElementById('display-role').innerText = currentUser.role === 'admin' ? 'Administrator' : 'Member';
                
                // Admin Features
                if(currentUser.role === 'admin') {
                    document.getElementById('admin-reset-btn').classList.remove('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    renderUserList();
                }
            }
        }

        function renderUserList() {
            const container = document.getElementById('user-list-container');
            container.innerHTML = users.map((u, i) => `
                <div class="admin-user-row">
                    <span>üë§ ${u.name} (${u.email}) - ${u.role}</span>
                    ${u.role !== 'admin' ? `<button onclick="deleteUser(${i})" style="color:red; border:none; background:none; cursor:pointer;">‡∏•‡∏ö</button>` : ''}
                </div>
            `).join('');
        }

        function deleteUser(index) {
            if(confirm('‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')) {
                users.splice(index, 1);
                saveSystem();
                renderUserList();
            }
        }

        function deleteAccount() {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏≤‡∏ß‡∏£?')) {
                users = users.filter(u => u.email !== currentUser.email);
                saveSystem();
                currentUser = null;
                sessionStorage.clear();
                location.reload();
            }
        }

        // ================= 4. GALLERY & BUYING =================
        function renderGallery(items) {
            const grid = document.getElementById('gallery');
            const fallback = 'https://placehold.co/600x400/EEE/31343C?text=Art+Space';

            if(items.length === 0) {
                grid.innerHTML = `<div style="text-align:center; width:100%; color:#aaa; grid-column:1/-1; padding:50px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
                return;
            }

            grid.innerHTML = items.map(item => {
                const isOwner = currentUser && (item.owner === currentUser.name || item.artist === currentUser.name);
                const isAdmin = currentUser && currentUser.role === 'admin';
                const canDelete = isOwner || isAdmin;
                
                let btnHtml = '';
                if(canDelete) btnHtml = `<button class="sold-badge" style="background:red; cursor:pointer;" onclick="deleteArt(${item.id})">‡∏•‡∏ö</button>`;
                else if(item.isSold) btnHtml = `<span class="sold-badge">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;

                // If Sold to ME
                if(item.isSold && currentUser && item.owner === currentUser.name) {
                    btnHtml = `<span class="sold-badge" style="background:green;">‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>`;
                }

                return `
                <div class="art-card ${item.isSold ? 'sold' : ''}">
                    ${btnHtml}
                    <img src="${item.img}" class="card-img" onerror="this.src='${fallback}'">
                    <div style="padding:15px;">
                        <h4>${item.title}</h4>
                        <div style="color:#888; font-size:13px;">‡πÇ‡∏î‡∏¢ ${item.artist}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                            <span style="color:var(--accent); font-weight:bold;">‡∏ø${item.price.toLocaleString()}</span>
                            ${!item.isSold && currentUser ? `<button onclick="buyArt(${item.id})" style="background:var(--accent); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">‡∏ã‡∏∑‡πâ‡∏≠</button>` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function buyArt(id) {
            if(!currentUser) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); return; }
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) {
                const art = artworks.find(a => a.id === id);
                art.isSold = true;
                art.owner = currentUser.name; // Transfer Ownership
                art.sales++;
                saveSystem();
                renderGallery(artworks);
                alert('‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß');
            }
        }

        function handleUpload(e) {
            e.preventDefault();
            if(!currentUser) return;
            
            const file = document.getElementById('upImage').files[0];
            const reader = new FileReader();
            reader.onload = function(evt) {
                const newArt = {
                    id: Date.now(),
                    title: document.getElementById('upTitle').value,
                    price: Number(document.getElementById('upPrice').value),
                    category: document.getElementById('upCategory').value,
                    artist: currentUser.name,
                    owner: currentUser.name, // Originally owned by creator
                    img: evt.target.result,
                    isSold: false,
                    sales: 0
                };
                artworks.unshift(newArt);
                saveSystem();
                renderGallery(artworks);
                e.target.reset();
                alert('‡∏•‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            }
            reader.readAsDataURL(file);
        }

        function deleteArt(id) {
            if(confirm('‡∏•‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) {
                artworks = artworks.filter(a => a.id !== id);
                saveSystem();
                renderGallery(artworks);
            }
        }

        // ================= 5. STUDIO & FILTER =================
        function openMyStudio() {
            document.getElementById('studio-panel').classList.remove('hidden');
            renderMyStudio('uploaded');
        }

        function renderMyStudio(mode) {
            // mode: 'uploaded' (‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏Ç‡∏≤‡∏¢) OR 'bought' (‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤)
            let myItems = [];
            if(mode === 'uploaded') {
                myItems = artworks.filter(a => a.artist === currentUser.name);
            } else {
                // Bought items: Owner is me, but Artist is NOT me (or bought from myself)
                // Logic: Items I own that are marked Sold
                myItems = artworks.filter(a => a.owner === currentUser.name && a.isSold);
            }
            renderGallery(myItems);
        }

        function filterGallery(cat, btn) {
            document.getElementById('studio-panel').classList.add('hidden'); // Hide studio when filtering main gallery
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            if(cat === 'all') renderGallery(artworks);
            else if(cat === 'sold') renderGallery(artworks.filter(a => a.isSold));
            else renderGallery(artworks.filter(a => a.category === cat));
        }

        function renderTopArtists() {
            // Mock logic for top artists
            const sorted = [...artworks].sort((a,b) => b.sales - a.sales).slice(0,3);
            document.getElementById('top-artists-grid').innerHTML = sorted.map((a,i) => `
                <div class="artist-rank-card">
                    <div class="rank-badge">${i+1}</div>
                    <img src="${a.img}" class="artist-img">
                    <b>${a.artist}</b>
                    <small>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ${a.sales}</small>
                </div>
            `).join('');
        }

        // Search
        function searchGallery() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = artworks.filter(a => a.title.toLowerCase().includes(term) || a.artist.toLowerCase().includes(term));
            renderGallery(filtered);
        }

        // Helpers
        function openAuthModal(mode='login') { 
            document.getElementById('auth-modal').classList.add('open'); 
            toggleAuth(mode);
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function resetView() { location.reload(); }

        // START
        initSystem();

    </script>
</body>
</html>